<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- My CSS -->
    <link rel="stylesheet" href="style.css">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">

    <!-- DataTables JavaScript -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

    <title>Hello, world!</title>
</head>


<body>

  <header class="flex justify-center">
    <div>
      <h1 class="page_title">Availability Consolidation</h1>
    </div>
  </header>

  <section class="max-w-xl mx-auto px-10 filter_container">
    <div class="space-y-8 filter_container-left">
      <div class="field_container">
        <label for="location-search"> WHERE ARE YOU LOOKING? </label>
        <input id="location-search" type="text" placeholder="Start typing a location" value="" />
      </div>
      <div class="field_container">
        <label for="workspaces-search">
          FOR ROUGHLY HOW MANY PEOPLE?
        </label>
        <input id="workspaces-search" type="number" min="0" value="0" />
      </div>
    </div>
    <div class="filter_container-right">
      <div class="flex justify-center">
        <h4 class="price_range-title">Price Range</h4>
      </div>
      <div class="filter-range_value">
        <span id="price_range_val-min"> £175 </span>
        <span> - </span>
        <span id="price_range_val-max"> £300,000 </span>
      </div>

      <div class="multi-range-slider">
        <input type="range" id="input-left" min="0" max="300000" value="0" />
        <input type="range" id="input-right" min="0" max="300000" value="300000" />

        <div class="slider">
          <div class="track"></div>
          <div class="range"></div>
          <div class="thumb left"></div>
          <div class="thumb right"></div>
        </div>
      </div>
    </div>
  </section>


  <!-- Table -->

  

  <section class="table_container">
    <table>
      <thead>
        <tr>
          <th id="cityHeader">City</th>
          <th id="locationHeader">Location</th>
          <th id="addressHeader">Address</th>
          <th id="workspaceHeader">WorkSpaces</th>
          <th id="lastpriceHeader">List Price</th>
          <th>Avilable From</th>
          <th>Name</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr>
          <td colspan="8">Refreshing with latest data, please wait...</td>
        </tr>
      </tbody>
    </table>
  </section>


  <!-- Table End -->


  <!-- Option 1: Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous">
  </script>

  <script>

    const CSV_URL = "latest.csv";
      let data = [],
        isLoading = true;
    
    // elements
    const inputLocation = document.getElementById("location-search");
    const inputWorkspaces = document.getElementById("workspaces-search");

    const inputLeft = document.getElementById("input-left");
    const inputRight = document.getElementById("input-right");
    const thumbLeft = document.querySelector(".slider > .thumb.left");
    const thumbRight = document.querySelector(".slider > .thumb.right");
    const range = document.querySelector(".slider > .range");

    const priceRangeValMin = document.getElementById("price_range_val-min");
    const priceRangeValMax = document.getElementById("price_range_val-max");


    let sortOrders = {};

function sortTable(column) {
  console.log(`Sorting table by ${column}`);
  
  // Initialize sort order if not already set
  if (!sortOrders[column]) {
    sortOrders[column] = 'asc';
  } else {
    // Toggle between 'asc' and 'desc'
    sortOrders[column] = sortOrders[column] === 'asc' ? 'desc' : 'asc';
  }

  data.sort((a, b) => {
    let valueA, valueB;

    if (column === 'WorkSpaces' || column === 'List Price') {
      valueA = parseFloat(a[column]) || 0;
      valueB = parseFloat(b[column]) || 0;
    } else {
      valueA = (a[column] || '').toUpperCase();
      valueB = (b[column] || '').toUpperCase();
    }

    let comparison = 0;
    if (valueA < valueB) {
      comparison = -1;
    } else if (valueA > valueB) {
      comparison = 1;
    }

    return sortOrders[column] === 'asc' ? comparison : -comparison;
  });

  loadData(data);
}



    document.addEventListener("DOMContentLoaded", function () {
      const cityHeader = document.getElementById("cityHeader");
      const locationHeader = document.getElementById("locationHeader");
    
      if (cityHeader) {
        cityHeader.addEventListener("click", function () {
          console.log("City column header clicked");
          sortTable('City');
        });
      }
    
      if (locationHeader) {
        locationHeader.addEventListener("click", function () {
          console.log("Location column header clicked");
          sortTable('Location');
        });
      }

      if(addressHeader) {
        addressHeader.addEventListener("click", function () {
          console.log("Address column header clicked");
          sortTable('Address');
        });
      }

      if(workspaceHeader) {
        workspaceHeader.addEventListener("click", function () {
          console.log("Workspaces column header clicked");
          sortTable('WorkSpaces');
        });
      }

      if(lastpriceHeader) {
        lastpriceHeader.addEventListener("click", function () {
          console.log("List Price column header clicked");
          sortTable('List Price');
        });
      }
    });


    // for slider functionality
    function setLeftValue() {
      var _this = inputLeft,
        min = parseInt(_this.min),
        max = parseInt(_this.max);

      _this.value = Math.min(
        parseInt(_this.value),
        parseInt(inputRight.value) - 5
      );

      var percent = ((_this.value - min) / (max - min)) * 100;

      thumbLeft.style.left = percent + "%";
      range.style.left = percent + "%";

      priceRangeValMin.innerHTML = "£" + _this.value;
      doSearch();
    }

    function setRightValue() {
      var _this = inputRight,
        min = parseInt(_this.min),
        max = parseInt(_this.max);

      _this.value = Math.max(
        parseInt(_this.value),
        parseInt(inputLeft.value) + 5
      );

      var percent = ((_this.value - min) / (max - min)) * 100;

      thumbRight.style.right = 100 - percent + "%";
      range.style.right = 100 - percent + "%";

      priceRangeValMax.innerHTML = "£" + _this.value;
      doSearch();
    }

    // helper functions for the search
    function searchByLocation(dt, query) {
      let regx = new RegExp(`^.*?\\b(${query}).*?`, "gi");
      if (!query) return true;
      else if (
        regx.test(dt["City"]) ||
        regx.test(dt["Location"]) ||
        regx.test(dt["Address"])
      ) {
        return true;
      }
      return false;
    }

    function searchByWorkspaces(dt, query) {
      if (query <= 0) return true;
      else if (+dt.WorkSpaces === +query) {
        return true;
      }
      return false;
    }

    function searchByPriceRange(dt, priceRangeMin, priceRangeMax) {
      try {
        if (
          dt["List Price"] &&
          Number(dt["List Price"].replace(/,/g, "")) >= priceRangeMin &&
          Number(dt["List Price"].replace(/,/g, "")) <= priceRangeMax
        ) {
          return true;
        }
        return false;
      } catch (err) {
        throw new Error(err);
      }
    }

    // the search function
    function doSearch() {
      let location = inputLocation.value;
      let workSpaces = inputWorkspaces.value;
      let priceRangeMin = inputLeft.value;
      let priceRangeMax = inputRight.value;

      let tempt = data.filter((dt) => {
        if (
          searchByLocation(dt, location) &&
          searchByWorkspaces(dt, workSpaces) &&
          searchByPriceRange(dt, priceRangeMin, priceRangeMax)
        ) {
          return true;
        } else {
          return false;
        }
      });
      loadData(tempt);
    }

    // load the data into the DOM
    function loadData(filteredData) {
      if (isLoading) return;

      const tableBody = document.getElementById("tbody");
      const newTableBody = document.createElement("tbody");
      newTableBody.setAttribute("id", "tbody");

      if (filteredData.length === 0) {
        const tableRow = document.createElement("tr");
        const tableCell = document.createElement("td");
        tableCell.setAttribute("colspan", 8);
        tableCell.textContent = "No data found!";
        tableRow.appendChild(tableCell);
        newTableBody.appendChild(tableRow);
      } else {
        filteredData.forEach((dt) => {
          const tableRow = document.createElement("tr");
          const cells = Object.values(dt);
          cells.forEach((cell) => {
            const tableCell = document.createElement("td");
            tableCell.textContent = cell;
            tableRow.appendChild(tableCell);
          });
          newTableBody.appendChild(tableRow);
        });
      }

      tableBody.parentNode.replaceChild(newTableBody, tableBody);
    }

    // CSV parser
    function parseCsvIntoJson(csv) {
      const lines = csv.split("\n");
      const headers = lines[0].split(",").map((header) => header.trim());
      const result = [];

      function parseCsvLine(row) {
        var insideQuote = false,
          entries = [],
          entry = [];
        row.split("").forEach(function (character) {
          if (character === '"') {
            insideQuote = !insideQuote;
          } else {
            if (character == "," && !insideQuote) {
              entries.push(entry.join(""));
              entry = [];
            } else {
              entry.push(character);
            }
          }
        });
        entries.push(entry.join(""));
        return entries;
      }

      for (let i = 1; i < lines.length; i++) {
        let dataLines = lines.slice(i);
        let data = dataLines.map(parseCsvLine)[0];
        const obj = {};

        for (let j = 0; j < headers.length; j++) {
          obj[headers[j]] = data[j];
        }

        result.push(obj);
      }

      return result;
    }

    // Sort Function 
    

    // fetch data from online URL
    function fetchCsv(endPoint) {
      fetch(endPoint)
        .then((response) => response.text())
        .then((csvData) => {
          data = parseCsvIntoJson(csvData);
          isLoading = false;
          loadData(data);
        })
        .catch((error) => {
          console.error("Error loading CSV file:", error);
        });
    }

    window.addEventListener("load", function () {
      // load data
      fetchCsv(CSV_URL);

      // call necessary functions
      setLeftValue();
      setRightValue();

      // range events
      inputLeft.addEventListener("input", setLeftValue);
      inputRight.addEventListener("input", setRightValue);

      // search events
      inputLocation.addEventListener("input", doSearch);
      inputWorkspaces.addEventListener("input", doSearch);

      // transitions
      inputLeft.addEventListener("mouseover", function () {
        thumbLeft.classList.add("hover");
      });
      inputLeft.addEventListener("mouseout", function () {
        thumbLeft.classList.remove("hover");
      });
      inputLeft.addEventListener("mousedown", function () {
        thumbLeft.classList.add("active");
      });
      inputLeft.addEventListener("mouseup", function () {
        thumbLeft.classList.remove("active");
      });
      inputRight.addEventListener("mouseover", function () {
        thumbRight.classList.add("hover");
      });
      inputRight.addEventListener("mouseout", function () {
        thumbRight.classList.remove("hover");
      });
      inputRight.addEventListener("mousedown", function () {
        thumbRight.classList.add("active");
      });
      inputRight.addEventListener("mouseup", function () {
        thumbRight.classList.remove("active");
      });
    });
  </script>


</body>

</html>